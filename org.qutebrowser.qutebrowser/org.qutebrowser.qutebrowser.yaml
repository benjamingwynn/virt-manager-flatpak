app-id: org.qutebrowser.qutebrowser
base: io.qt.qtwebengine.BaseApp
base-version: '5.14'
runtime: org.kde.Platform
runtime-version: '5.14'
sdk: org.kde.Sdk
command: qutebrowser
rename-icon: qutebrowser
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'
finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
modules:
  - name: qutebrowser
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
      - make --file misc/Makefile install PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/qutebrowser/qutebrowser/archive/v1.13.0.tar.gz
        sha256: 68de36b7e9743828984f841dc49fbf5f145d32d965f0db007051430422bc5f74
    cleanup:
      - /share/man
    modules:
      - name: asciidoc
        sources:
          - type: archive
            url: https://github.com/asciidoc/asciidoc-py3/archive/9.0.0.tar.gz
            sha256: 04f219e24476ce169508917766e93279d13b3de69ae9ce40fdfd908162e441c4
          - type: shell
            commands:
              - autoconf
              - ./configure
        cleanup:
          - '*'
      - name: python-attrs
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - pip3 install --prefix=${FLATPAK_DEST} attrs==19.3.0
      - name: python-jinja2
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - pip3 install --prefix=${FLATPAK_DEST} jinja2==2.11.2
      - name: python-markupsafe
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - pip3 install --prefix=${FLATPAK_DEST} markupsafe==1.1.1
      - name: python-pygments
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - pip3 install --prefix=${FLATPAK_DEST} pygments==2.6.1
        cleanup:
          - '/bin'
      - name: python-pypeg2
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - pip3 install --prefix=${FLATPAK_DEST} pypeg2==2.15.2
      - name: python-pyaml
        buildsystem: simple
        build-options:
          build-args:
            - --share=network
        build-commands:
          - pip3 install --prefix=${FLATPAK_DEST} pyaml==20.4.0
      - name: pyqt5-webengine
#       buildsystem: simple
#       build-commands:
#         - python3 configure.py -w --sipdir=/app/share/sip/PyQt5 --pyqt-sipdir=/app/share/sip/PyQt5
#         - sip-build --no-make --api-dir /app/share/qt/qsci/api/python
#         - cd build && make
#         - cd build && make install
        build-options:
          env:
            - QMAKEPATH=/app/lib
        config-opts:
          - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.7m'
          - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.7m'
          - QMAKE_INCDIR+=/app/include/QtWebEngine
          - QMAKE_INCDIR+=/app/include/QtWebEngineCore
          - QMAKE_INCDIR+=/app/include/QtWebEngineWidgets
        sources:
          - type: archive
#           url: https://www.riverbankcomputing.com/static/Downloads/PyQtWebEngine/5.13.2/PyQtWebEngine-5.13.2.tar.gz
#           sha256: 4264911b5847c75721d8c9c30af92e58a216bd25ceef37f7abf921005c1d45a9
#           url: https://pypi.python.org/packages/source/P/PyQtWebEngine/PyQtWebEngine-5.14.0.tar.gz
#           sha256: e11595051f8bfbfa49175d899b2c8c2eea3a3deac4141edf4db68c3555221c92
            # https://www.riverbankcomputing.com/pipermail/pyqt/2020-June/042985.html
            url: https://pypi.python.org/packages/source/P/PyQtWebEngine/PyQtWebEngine-5.15.0.tar.gz
            sha256: 670812688e40bf75f70ddf01eadd897d231300318d3856b275bf8e7e0085bf75
          - type: script
            commands:
              - processed=`sed -e 's|prefix|sysroot|' <<< $@`
              - python3 configure.py $processed
            dest-filename: configure
#       sources:
#         - type: archive
#           url: https://pypi.python.org/packages/source/P/PyQtWebEngine/PyQtWebEngine-5.15.0.tar.gz
#           sha256: 670812688e40bf75f70ddf01eadd897d231300318d3856b275bf8e7e0085bf75
        cleanup:
          - /lib/debug
        modules:
          - name: python-pyqt5-sip
            buildsystem: simple
            build-commands:
              - python3 setup.py build
              - python3 setup.py install --skip-build --prefix=/app
            sources:
              - type: archive
                url: https://pypi.python.org/packages/source/P/PyQt5-sip/PyQt5_sip-12.8.0.tar.gz
                sha256: 0a34b6596bdd28d52da3a51fa8d9bb0b287bcb605c2512aa3251b9028cc71f4d
          - name: pyqt5
            config-opts:
              - --assume-shared
              - --concatenate
              - --confirm-license
              - --enable=QtCore
              - --enable=QtGui
              - --enable=QtNetwork
              - --enable=QtOpenGL
              - --enable=QtPrintSupport
              - --enable=QtQml
              - --enable=QtQuick
              - --enable=QtSql
              - --enable=QtWebChannel
              - --enable=QtWidgets
              - --no-designer-plugin
              - --no-dist-info
              - --no-docstrings
              - --no-qml-plugin
              - --no-qsci-api
              - --no-stubs
              - --no-tools
              - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.7m'
              - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.7m'
            sources:
              - type: archive
#               url: https://www.riverbankcomputing.com/static/Downloads/PyQt5/5.13.2/PyQt5-5.13.2.tar.gz
#               sha256: adc17c077bf233987b8e43ada87d1e0deca9bd71a13e5fd5fc377482ed69c827
#               url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.14.0.tar.gz
#               sha256: 0145a6b7de15756366decb736c349a0cb510d706c83fda5b8cd9e0557bc1da72
#               url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.14.2.tar.gz
#               sha256: bd230c6fd699eabf1ceb51e13a8b79b74c00a80272c622427b80141a22269eb0
                url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.15.0.tar.gz
                sha256: c6f75488ffd5365a65893bc64ea82a6957db126fbfe33654bcd43ae1c30c52f9
              - type: script
                commands:
                - processed=`sed -e 's|prefix|sysroot|' <<< $@`
                - python3 configure.py $processed
                dest-filename: configure
            cleanup:
              - /lib/debug
              - /share/sip
            modules:
#             - name: sip
#             # pyqt5-webengine fail to build without sip?
#               config-opts:
#                 - --no-dist-info
#                 - --no-stubs
#                 - --bindir=/app/bin
#                 - --destdir=/app/lib/python3.7/site-packages
#                 - --incdir=/app/include
#                 - --pyidir=/app/lib/python3.7/site-packages
#                 - --sipdir=/app/share/sip
#                 - --sip-module PyQt5.sip
#               sources:
#                 - type: archive
#                   url: https://www.riverbankcomputing.com/static/Downloads/sip/4.19.22/sip-4.19.22.tar.gz
#                   sha256: e1b768824ec1a2ee38dd536b6b6b3d06de27b00a2f5f55470d1b512306e3be45
#                 - type: script
#                   commands:
#                     - processed=`sed -e 's|--prefix=/app||' <<< $@`
#                     - python3 configure.py $processed
#                   dest-filename: configure
#               cleanup:
#                 - /bin
#                 - /include
              - name: sip5
                buildsystem: simple
                ensure-writable:
                  - /lib/python3.7/site-packages/easy-install.pth
                build-commands:
                  - python3 setup.py build
                  - python3 setup.py install --skip-build --prefix=/app
                sources:
                  - type: archive
                    url: https://pypi.python.org/packages/source/s/sip/sip-5.3.0.tar.gz
                    sha256: 03a44e20b252ef03ca2891e9439d238af3fd8245f65cdcff238a843d4f455b80
#               cleanup:
#                 - /bin
#                 - /include
                modules:
                  - name: python-toml
                    buildsystem: simple
                    ensure-writable:
                      - /lib/python3.7/site-packages/easy-install.pth
                    build-commands:
                      - python3 setup.py build
                      - python3 setup.py install --skip-build --prefix=/app
                    sources:
                      - type: archive
                        url: https://files.pythonhosted.org/packages/source/t/toml/toml-0.10.1.tar.gz
                        sha256: 926b612be1e5ce0634a2ca03470f95169cf16f939018233a670519cb4ac58b0f
                  - name: python-packaging
                    buildsystem: simple
                    ensure-writable:
                      - /lib/python3.7/site-packages/easy-install.pth
                    build-commands:
                      - python3 setup.py build
                      - python3 setup.py install --skip-build --prefix=/app
                    sources:
                      - type: archive
                        url: https://pypi.io/packages/source/p/packaging/packaging-20.4.tar.gz
                        sha256: 4357f74f47b9c12db93624a82154e9b120fa8293699949152b22065d556079f8
                    modules:
                      - name: python-pyparsing
                        buildsystem: simple
                        ensure-writable:
                          - /lib/python3.7/site-packages/easy-install.pth
                        build-commands:
                          - python3 setup.py build
                          - python3 setup.py install --skip-build --prefix=/app
                        sources:
                          - type: archive
                            url: https://github.com/pyparsing/pyparsing/archive/pyparsing_2.4.7.tar.gz
                            sha256: 6deecf4b95a49a5a9c89b4a4b1fcb73c1cba0e3265ec7b858adffcced229ba05
              - name: pyqt-builder
                buildsystem: simple
                ensure-writable:
                  - /lib/python3.7/site-packages/easy-install.pth
                build-commands:
                  - python3 setup.py build
                  - python3 setup.py install --skip-build --prefix=/app
                sources:
                  - type: archive
                    url: https://pypi.io/packages/source/P/PyQt-builder/PyQt-builder-1.4.0.tar.gz
                    sha256: be7fb8436e6ffb21b7e42266f0fa4776b7d62b0c7e06c63f8a066ff90554fcdc
      - name: pdfjs
        buildsystem: simple
        build-commands:
          - unzip pdfjs-*.zip
          - mkdir /app/share/pdf.js
          - cp -R {LICENSE,build,web} /app/share/pdf.js
          - find /app/share/pdf.js -type f -exec chmod 644 {} \;
        sources:
          - type: file
            url: https://github.com/mozilla/pdf.js/releases/download/v2.4.456/pdfjs-2.4.456-dist.zip
            sha256: bd0c36f90130150898890a9972b053601c743ba782543df498a862266f5a7077
